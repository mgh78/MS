<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RAG Assistant</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg: #0b1020;
        --bg-2: #0b1427;
        --card: #0f1631;
        --card-2: #111a3d;
        --text: #e8ecf3;
        --muted: #9aa3b2;
        --accent: #4f7cff;
        --accent-2: #7a5cff;
        --success: #33d69f;
        --danger: #ff5d5d;
        --border: rgba(255,255,255,0.08);
      }
      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f7f8fb;
          --bg-2: #ffffff;
          --card: #ffffff;
          --card-2: #f3f5fb;
          --text: #0f172a;
          --muted: #5b6678;
          --accent: #3b82f6;
          --accent-2: #8b5cf6;
          --border: rgba(15,23,42,0.08);
        }
      }
      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        color: var(--text);
        font-family: Vazirmatn, "Noto Naskh Arabic", "Noto Sans Arabic", Tahoma, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        background: radial-gradient(1200px 600px at 10% -10%, rgba(79,124,255,0.15), transparent 60%),
                    radial-gradient(1000px 500px at 100% 0%, rgba(122,92,255,0.14), transparent 60%),
                    linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      }
      .shell {
        min-height: 100%;
        display: grid;
        grid-template-rows: auto 1fr auto;
      }
      .header {
        position: sticky; top: 0;
        display: flex; align-items: center; justify-content: space-between;
        gap: 1rem; padding: 1rem 1.25rem; backdrop-filter: saturate(150%) blur(10px);
        background: linear-gradient(0deg, rgba(0,0,0,0.06), rgba(0,0,0,0.06));
        border-bottom: 1px solid var(--border);
      }
      .brand { display: flex; align-items: center; gap: 0.9rem; }
      .logo { width: 36px; height: 36px; border-radius: 10px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); display: grid; place-items: center; font-weight: 800; color: white; box-shadow: 0 8px 22px rgba(79,124,255,0.35); }
      .title { font-weight: 700; letter-spacing: 0.2px; font-size: 1.05rem; }
      .badge { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 999px; background: rgba(79,124,255,0.12); color: var(--text); border: 1px solid var(--border); }

      .container { max-width: 900px; width: 100%; margin: 0 auto; padding: 1rem; }
      .chat { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)), var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; box-shadow: 0 25px 60px rgba(0,0,0,0.25); }
      .chat-body { height: calc(100vh - 220px); min-height: 380px; max-height: 68vh; overflow-y: auto; padding: 1rem 1.1rem; scroll-behavior: smooth; }
      .messages { display: grid; gap: 0.75rem; }
      .bubble { position: relative; max-width: 80%; padding: 0.9rem 1rem; border: 1px solid var(--border); border-radius: 14px; white-space: pre-wrap; line-height: 1.45; }
      .bubble[dir="rtl"] { font-family: Vazirmatn, "Noto Naskh Arabic", "Noto Sans Arabic", Tahoma, sans-serif; letter-spacing: 0; }
      .user { justify-self: end; background: linear-gradient(135deg, rgba(79,124,255,0.16), rgba(122,92,255,0.16)); border-color: rgba(79,124,255,0.3); }
      .assistant { justify-self: start; background: rgba(255,255,255,0.04); }
      .meta { display: flex; gap: 0.5rem; align-items: center; color: var(--muted); font-size: 0.8rem; margin-top: 0.35rem; }
      .copy { position: absolute; top: 8px; right: 18px; background: transparent; border: 1px solid var(--border); color: var(--muted); border-radius: 8px; padding: 0.25rem 0.45rem; cursor: pointer; font-size: 0.75rem; }
      .copy:hover { color: var(--text); border-color: rgba(255,255,255,0.2); }

      .composer { display: grid; grid-template-columns: 1fr auto; gap: 0.75rem; padding: 0.9rem; border-top: 1px solid var(--border); background: linear-gradient(180deg, var(--card), var(--card-2)); }
      .input { width: 100%; resize: none; min-height: 46px; max-height: 140px; padding: 0.9rem 1rem; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12); color: var(--text); border-radius: 12px; outline: none; line-height: 1.35; }
      .input:focus { border-color: rgba(79,124,255,0.65); box-shadow: 0 0 0 3px rgba(79,124,255,0.18); }
      .actions { display: flex; align-items: center; gap: 0.5rem; }
      .btn { padding: 0.85rem 1.1rem; border-radius: 12px; border: 1px solid rgba(79,124,255,0.6); background: linear-gradient(135deg, rgba(79,124,255,0.95), rgba(122,92,255,0.95)); color: white; cursor: pointer; font-weight: 650; }
      .btn[disabled] { opacity: 0.7; cursor: wait; }
      .btn.secondary { background: transparent; color: var(--text); border: 1px solid var(--border); }
      .hint { color: var(--muted); font-size: 0.85rem; }

      .footer { display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 0.85rem 0; color: var(--muted); }
      .dot-typing { display: inline-flex; gap: 6px; }
      .dot-typing span { width: 6px; height: 6px; background: var(--muted); border-radius: 999px; display: inline-block; opacity: 0.4; animation: blink 1.2s infinite; }
      .dot-typing span:nth-child(2) { animation-delay: .2s; }
      .dot-typing span:nth-child(3) { animation-delay: .4s; }
      @keyframes blink { 0%, 100% { opacity: 0.3; transform: translateY(0); } 50% { opacity: 1; transform: translateY(-2px); } }
    </style>
  </head>
  <body>
    <div class="shell">
      <header class="header">
        <div class="brand">
          <div class="logo">R</div>
          <div>
            <div class="title">RAG Assistant</div>
            <div class="hint">Local RAG + Smart Web Search</div>
          </div>
        </div>
        <div class="badge">Online</div>
      </header>

      <main class="container">
        <section class="chat" aria-live="polite">
          <div id="chat-body" class="chat-body">
            <div id="messages" class="messages"></div>
          </div>
          <form id="composer" class="composer">
            <textarea id="question" name="question" class="input" placeholder="Ask anything… (Cmd/Ctrl+Enter to send)" rows="1" autofocus></textarea>
            <div class="actions">
              <button id="clear" class="btn secondary" type="button">Clear</button>
              <button id="web" class="btn secondary" type="button" style="display:none">Search the web</button>
              <button id="submit" class="btn" type="submit">Send</button>
            </div>
          </form>
        </section>

        <div class="footer">
          <span>Powered by Qdrant • Ollama • Tavily</span>
          <span id="latency" class="hint"></span>
        </div>
      </main>
    </div>

    <script>
      const messagesEl = document.getElementById('messages');
      const chatBody = document.getElementById('chat-body');
      const form = document.getElementById('composer');
      const input = document.getElementById('question');
      const submitBtn = document.getElementById('submit');
      const webBtn = document.getElementById('web');
      const clearBtn = document.getElementById('clear');
      const latencyEl = document.getElementById('latency');

      let lastQuestion = '';

      function isRTL(text) {
        // Detect Arabic/Persian script range
        return /[\u0600-\u06FF]/.test(text || '');
      }

      function addMessage(role, text, meta = '') {
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role}`;
        const safe = text == null ? '' : String(text);
        bubble.textContent = safe;

        const rtl = isRTL(safe);
        bubble.dir = rtl ? 'rtl' : 'ltr';
        bubble.style.textAlign = rtl ? 'right' : 'left';

        if (role === 'assistant') {
          const copy = document.createElement('button');
          copy.className = 'copy';
          copy.type = 'button';
          copy.textContent = 'Copy';
          copy.addEventListener('click', () => {
            navigator.clipboard.writeText(safe).then(() => {
              copy.textContent = 'Copied';
              setTimeout(() => (copy.textContent = 'Copy'), 1200);
            });
          });
          bubble.appendChild(copy);
        }

        const metaEl = document.createElement('div');
        metaEl.className = 'meta';
        metaEl.textContent = meta;
        if (meta) bubble.appendChild(metaEl);

        messagesEl.appendChild(bubble);
        chatBody.scrollTop = chatBody.scrollHeight;
        return bubble;
      }

      

      function addTyping() {
        const wrap = document.createElement('div');
        wrap.className = 'bubble assistant';
        const dots = document.createElement('div');
        dots.className = 'dot-typing';
        dots.innerHTML = '<span></span><span></span><span></span>';
        wrap.appendChild(dots);
        messagesEl.appendChild(wrap);
        chatBody.scrollTop = chatBody.scrollHeight;
        return wrap;
      }

      function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = Math.min(140, el.scrollHeight) + 'px';
      }
      input.addEventListener('input', () => autoResize(input));

      clearBtn.addEventListener('click', () => {
        messagesEl.innerHTML = '';
        latencyEl.textContent = '';
        input.value = '';
        autoResize(input);
        input.focus();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const question = input.value.trim();
        if (!question) return;
        lastQuestion = question;

        addMessage('user', question);
        input.value = '';
        autoResize(input);
        input.focus();

        submitBtn.disabled = true;
        const typing = addTyping();
        latencyEl.textContent = '';
        const started = performance.now();

        try {
          // Non-streaming RAG request
          const res = await fetch('/api/rag', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question })
          });
          const data = await res.json();
          const ended = performance.now();
          const ms = Math.max(0, Math.round(ended - started));
          latencyEl.textContent = ms + ' ms';

          typing.remove();
          const answer = (data && data.answer) || (data && data.error) || 'No answer';
          addMessage('assistant', answer);
          const text = String(answer || '').toLowerCase();
          webBtn.style.display = (text.startsWith("i don't know")) ? 'inline-block' : 'none';
        } catch (err) {
          typing.remove();
          addMessage('assistant', 'Request failed. Please try again.');
        } finally {
          submitBtn.disabled = false;
        }
      });

      // Web search flow (only when user clicks)
      webBtn.addEventListener('click', async () => {
        if (!lastQuestion) return;
        webBtn.disabled = true;
        const typing = addTyping();
        latencyEl.textContent = '';
        const started = performance.now();
        try {
          const res = await fetch('/api/web', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ question: lastQuestion })
          });
          const data = await res.json();
          const ended = performance.now();
          const ms = Math.max(0, Math.round(ended - started));
          latencyEl.textContent = ms + ' ms';

          typing.remove();
          const answer = (data && data.answer) || (data && data.error) || 'No answer';
          addMessage('assistant', answer);
          webBtn.style.display = 'none';
        } catch (err) {
          typing.remove();
          addMessage('assistant', 'Web search failed. Check TAVILY_API_KEY.');
        } finally {
          webBtn.disabled = false;
        }
      });

      // Cmd/Ctrl+Enter shortcut
      input.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
          form.requestSubmit();
        }
      });
    </script>
  </body>
  </html>

